<!-- <script>
  document.querySelector('hy-push-state').setAttribute('prefetch', '');

  document.querySelectorAll('.sidebar a[href^="/"]').forEach(function (el) { 
    el.addEventListener('click', function (e) {
      if (el.pathname === window.location.pathname) {
        e.preventDefault();
        e.stopPropagation();
        document.querySelector('hy-drawer').close();
      }
    });
  });
</script> -->

<!--
Code for integrating CloudFlare's email protection with Hydejack's single page app loading.
-->
<script>
  document.getElementById('_pushState').addEventListener('hy-push-state-after', function (e) {
    function e(e){
      (console.error?console.error:console.log).call(console,e)
    }

    function t(e){
      return l.innerHTML='<a href="'+e.replace(/"/g,"&quot;")+'"></a>',l.childNodes[0].getAttribute("href")
    }

    function r(e,t){
      var r=e.substr(t,2);return parseInt(r,16)
    }

    function n(e,n){
      for(var o="",c=r(e,n),a=n+2;a<e.length;a+=2){
        var l=r(e,a)^c;
        o+=String.fromCharCode(l)
      }
      return t(o)
    }

    var o="/cdn-cgi/l/email-protection#",
        c=".__cf_email__",
        a="data-cfemail",
        l=document.createElement("div");

    !function(){
      for(var t=document.getElementsByTagName("a"),r=0;r<t.length;r++)
        try{
          var c=t[r],a=c.href.indexOf(o);
          a>-1&&(c.href="mailto:"+n(c.href,a+o.length))
        }catch(t){
          e(t)
        }
    }(),
    function(){
      for(var t=document.querySelectorAll(c),r=0;r<t.length;r++)
        try{
          var o=t[r],l=n(o.getAttribute(a),0),i=document.createTextNode(l);
          o.parentNode.replaceChild(i,o)
        }catch(t){
          e(t)
        }
    }()
  });
</script>

{% comment %}
<!--
Example code for using Matamo as alternative analytics solution.
-->
{% if site.matomo_analytics %}
<script>
  var _paq = _paq || [];

  /*{% if site.matomo_analytics.no_cookies %}*/
  _paq.push(['disableCookies']);
  /*{% endif %}*/

  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  _paq.push(['setTrackerUrl', u+'piwik.php']);
  _paq.push(['setSiteId', '{{site.matomo_analytics.site_id}}']);

  var pushStateEl = document.getElementById('_pushState');
  var timeStartLoadPage, referer, timeItTookToLoadPage;

  pushStateEl.addEventListener('hy-push-state-start', function() {
    timeStartLoadPage = new Date().getTime();
    referer = window.location.toString();
  });

  pushStateEl.addEventListener('hy-push-state-ready', function() {
    timeItTookToLoadPage = new Date().getTime() - timeStartLoadPage;
  });

  pushStateEl.addEventListener('hy-push-state-after', function() {
    _paq.push(['setReferrerUrl', referer]);
    _paq.push(['setCustomUrl', window.location.toString()]);
    _paq.push(['setDocumentTitle', document.title]);
    _paq.push(['deleteCustomVariables', 'page']);
    _paq.push(['setGenerationTimeMs', timeItTookToLoadPage]);
    _paq.push(['trackPageView']);
  });

  window.loadJSDeferred('{{site.matomo_analytics.root}}piwik.js');
</script>
{% endif %}
{% endcomment %}


<script>
  (function () {
    const REPO = 'donydchen/donydchen.github.io';
    const API_URL = `https://api.github.com/repos/${REPO}`;
    const FOOTER_ID = 'footer-info';
    let footerUpdated = false;
    let updateTimeout = null;

    async function fetchRepo() {
      const cached = sessionStorage.getItem('repo-data');
      if (cached) return JSON.parse(cached);
      const res = await fetch(API_URL);
      if (!res.ok) throw new Error('GitHub API error ' + res.status);
      const data = await res.json();
      sessionStorage.setItem('repo-data', JSON.stringify(data));
      return data;
    }

    async function updateFooter() {
      if (footerUpdated) return;
      footerUpdated = true;

      try {
        const repo = await fetchRepo();
        const lastUpdated = new Date(repo.pushed_at).toLocaleString('en-GB', {
          timeZone: 'Asia/Singapore',
          day: '2-digit', month: 'short', year: 'numeric',
          hour: '2-digit', minute: '2-digit', timeZoneName: 'short'
        });
        const createdYear = new Date(repo.created_at).getUTCFullYear();
        const currentYear = new Date().getUTCFullYear();
        const siteTitle = (document.title.split('|')[0] || '').trim() + '.';

        const html = `
                <p>&copy; Copyright ${createdYear}-${currentYear} ${siteTitle}</p>
                <p>Last updated: ${lastUpdated}</p>
            `;

        const target = document.getElementById(FOOTER_ID);
        if (target) target.innerHTML = html;
      } catch (e) {
        console.warn('Footer update failed:', e);
      }
    }

    function scheduleUpdate(delay = 250) {
      footerUpdated = false;
      clearTimeout(updateTimeout);
      updateTimeout = setTimeout(updateFooter, delay);
    }

    document.addEventListener('DOMContentLoaded', scheduleUpdate);

    function attachPushStateListeners() {
      const hyEl = document.querySelector('hy-push-state');
      if (!hyEl) return;
      ['hy-push-state-after', 'hy-push-state-ready'].forEach(ev =>
        hyEl.addEventListener(ev, () => scheduleUpdate(400))
      );
    }

    attachPushStateListeners();
    document.addEventListener('DOMContentLoaded', attachPushStateListeners);

    /* add specific text style to all text within the about section */
    function markAboutContents() {
      let start = document.getElementById('about');
      let end = document.getElementById('news-notes');
      if (!start || !end) return;
      if (start.compareDocumentPosition(end) & Node.DOCUMENT_POSITION_PRECEDING) {
        const tmp = start; start = end; end = tmp;
      }
      document.querySelectorAll('p.about-contents').forEach(p => p.classList.remove('about-contents'));
      const paras = [];
      paras.push(...start.querySelectorAll('p'));
      let node = start.nextSibling;
      while (node && node !== end) {
        if (node.nodeType === Node.ELEMENT_NODE) {
          paras.push(...node.querySelectorAll('p'));
          if (node.tagName === 'P') paras.push(node);
        }
        node = node.nextSibling;
      }
      paras.push(...end.querySelectorAll('p'));
      if (end.tagName === 'P') paras.push(end);
      const seen = new Set();
      paras.forEach(p => {
        if (!seen.has(p)) {
          seen.add(p);
          p.classList.add('about-contents');
        }
      });
    }
    document.addEventListener('DOMContentLoaded', markAboutContents);
    function scheduleMarking(delay = 250) {
      clearTimeout(scheduleMarking._t);
      scheduleMarking._t = setTimeout(markAboutContents, delay);
    }
    function attachMarkingListeners() {
      const hyEl = document.querySelector('hy-push-state');
      if (!hyEl) return;
      ['hy-push-state-after', 'hy-push-state-ready'].forEach(ev =>
        hyEl.addEventListener(ev, () => scheduleMarking(400))
      );
    }
    attachMarkingListeners();
    document.addEventListener('DOMContentLoaded', attachMarkingListeners);

  })();
</script>
